<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FanZone Error Handling Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-btn { margin: 5px; padding: 10px 20px; cursor: pointer; }
        .success { background: #d4edda; }
        .error { background: #f8d7da; }
        .warning { background: #fff3cd; }
        .info { background: #d1ecf1; }
        #logs { margin-top: 20px; padding: 10px; background: #f5f5f5; border-radius: 5px; max-height: 400px; overflow-y: auto; }
        .log-entry { margin: 5px 0; padding: 5px; border-radius: 3px; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>FanZone Error Handling Test Suite</h1>
    
    <div class="test-section">
        <h2>1. Test Error Categories</h2>
        <button class="test-btn" onclick="testTelegramError()">Test Telegram Error</button>
        <button class="test-btn" onclick="testDatabaseError()">Test Database Error</button>
        <button class="test-btn" onclick="testServiceError()">Test Service Error</button>
        <button class="test-btn" onclick="testNetworkError()">Test Network Error</button>
        <button class="test-btn" onclick="testAuthError()">Test Auth Error</button>
    </div>
    
    <div class="test-section">
        <h2>2. Test Recovery Mechanisms</h2>
        <button class="test-btn" onclick="testFallbackMode()">Enable Fallback Mode</button>
        <button class="test-btn" onclick="testOfflineMode()">Enable Offline Mode</button>
        <button class="test-btn" onclick="clearModes()">Clear All Modes</button>
    </div>
    
    <div class="test-section">
        <h2>3. Test Error Logging</h2>
        <button class="test-btn" onclick="viewErrorLog()">View Error Log</button>
        <button class="test-btn" onclick="exportErrorLog()">Export Error Log</button>
        <button class="test-btn" onclick="clearErrorLog()">Clear Error Log</button>
    </div>
    
    <div class="test-section">
        <h2>4. Test Full Initialization</h2>
        <button class="test-btn" onclick="testFullInit()">Test Full Initialization</button>
    </div>
    
    <div id="logs">
        <h3>Test Logs:</h3>
    </div>
    
    <!-- Load all FanZone files -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="utils.js"></script>
    <script src="src/core/interfaces.js"></script>
    <script src="src/core/EventBus.js"></script>
    <script src="src/core/Logger.js"></script>
    <script src="src/core/ErrorHandler.js"></script>
    <script src="src/core/DIContainer.js"></script>
    <script src="src/adapters/TelegramAdapter.js"></script>
    <script src="src/repositories/SupabaseRepository.js"></script>
    <script src="src/services/AuthService.js"></script>
    <script src="src/services/UserService.js"></script>
    <script src="src/services/GiftService.js"></script>
    <script src="src/controllers/GiftsController.js"></script>
    <script src="src/controllers/LeaderboardController.js"></script>
    <script src="src/controllers/ProfileController.js"></script>
    <script src="app.js"></script>
    
    <script>
        const logContainer = document.getElementById('logs');
        
        function addLog(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // Test functions
        function testTelegramError() {
            addLog('Testing Telegram error...', 'info');
            const error = new Error('Telegram WebApp is not defined');
            const result = window.ErrorHandler.handleInitError(error, 'test_telegram');
            addLog(`Result: ${result.category} - ${result.userMessage}`, result.recoveryPossible ? 'warning' : 'error');
            addLog(`Recovery: ${result.recoveryPossible ? result.recoveryAction : 'Not possible'}`, 'info');
        }
        
        function testDatabaseError() {
            addLog('Testing Database error...', 'info');
            const error = new Error('Failed to connect to Supabase database');
            const result = window.ErrorHandler.handleInitError(error, 'test_database');
            addLog(`Result: ${result.category} - ${result.userMessage}`, result.recoveryPossible ? 'warning' : 'error');
            addLog(`Recovery: ${result.recoveryPossible ? result.recoveryAction : 'Not possible'}`, 'info');
        }
        
        function testServiceError() {
            addLog('Testing Service error...', 'info');
            const error = new Error('Missing required services: authService, userService');
            const result = window.ErrorHandler.handleInitError(error, 'test_service');
            addLog(`Result: ${result.category} - ${result.userMessage}`, 'error');
        }
        
        function testNetworkError() {
            addLog('Testing Network error...', 'info');
            const error = new Error('Network request timeout');
            const result = window.ErrorHandler.handleInitError(error, 'test_network');
            addLog(`Result: ${result.category} - ${result.userMessage}`, result.recoveryPossible ? 'warning' : 'error');
            addLog(`Recovery: ${result.recoveryPossible ? result.recoveryAction : 'Not possible'}`, 'info');
        }
        
        function testAuthError() {
            addLog('Testing Auth error...', 'info');
            const error = new Error('Authentication failed: Invalid user credentials');
            const result = window.ErrorHandler.handleInitError(error, 'test_auth');
            addLog(`Result: ${result.category} - ${result.userMessage}`, result.recoveryPossible ? 'warning' : 'error');
            addLog(`Recovery: ${result.recoveryPossible ? result.recoveryAction : 'Not possible'}`, 'info');
        }
        
        function testFallbackMode() {
            addLog('Enabling fallback mode...', 'info');
            window.ErrorHandler.enableFallbackMode();
            addLog('Fallback mode enabled. Telegram features will be disabled on next reload.', 'success');
        }
        
        function testOfflineMode() {
            addLog('Enabling offline mode...', 'info');
            window.ErrorHandler.enableOfflineMode();
            addLog('Offline mode enabled. Database features will use local storage on next reload.', 'success');
        }
        
        function clearModes() {
            addLog('Clearing all modes...', 'info');
            localStorage.removeItem('fanzone_fallback_mode');
            localStorage.removeItem('fanzone_offline_mode');
            addLog('All modes cleared. App will run normally on next reload.', 'success');
        }
        
        function viewErrorLog() {
            const log = window.ErrorHandler.getErrorLog();
            addLog(`Error log contains ${log.length} entries:`, 'info');
            log.slice(-5).forEach(entry => {
                addLog(`[${entry.category}] ${entry.context}: ${entry.errorMessage}`, 'error');
            });
        }
        
        function exportErrorLog() {
            window.ErrorHandler.exportErrorLog();
            addLog('Error log exported to file', 'success');
        }
        
        function clearErrorLog() {
            window.ErrorHandler.clearErrorLog();
            addLog('Error log cleared', 'success');
        }
        
        async function testFullInit() {
            addLog('Starting full initialization test...', 'info');
            
            try {
                // Test file verification
                addLog('Step 1: Verifying files...', 'info');
                const required = ['DIContainer', 'EventBus', 'Logger', 'ErrorHandler', 'TelegramAdapter'];
                const missing = required.filter(name => !window[name]);
                if (missing.length > 0) {
                    throw new Error(`Missing files: ${missing.join(', ')}`);
                }
                addLog('‚úÖ All files loaded', 'success');
                
                // Test DIContainer initialization
                addLog('Step 2: Initializing DIContainer...', 'info');
                await window.DIContainer.initializeApp();
                addLog('‚úÖ DIContainer initialized', 'success');
                
                // Test app creation
                addLog('Step 3: Creating FanZone app...', 'info');
                window.FanZoneApp = new FanZoneApplication(window.DIContainer);
                addLog('‚úÖ App created', 'success');
                
                // Test app initialization
                addLog('Step 4: Initializing app...', 'info');
                await window.FanZoneApp.initialize();
                addLog('‚úÖ App initialized successfully!', 'success');
                
                addLog('üéâ Full initialization test PASSED!', 'success');
                
            } catch (error) {
                addLog(`‚ùå Initialization failed: ${error.message}`, 'error');
                
                if (window.ErrorHandler) {
                    const errorInfo = window.ErrorHandler.handleInitError(error, 'full_init_test');
                    addLog(`Error handled: ${errorInfo.category}`, 'warning');
                    addLog(`User message: ${errorInfo.userMessage}`, 'info');
                    if (errorInfo.recoveryPossible) {
                        addLog(`Recovery available: ${errorInfo.recoveryAction}`, 'success');
                    }
                }
            }
        }
        
        // Initial log
        addLog('Error handling test suite loaded', 'success');
        addLog('ErrorHandler available: ' + (!!window.ErrorHandler), window.ErrorHandler ? 'success' : 'error');
    </script>
</body>
</html>