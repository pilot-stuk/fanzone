<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FanZone Service Validation Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .test-btn { margin: 5px; padding: 10px 20px; cursor: pointer; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        #logs { margin-top: 20px; padding: 10px; background: #f5f5f5; border-radius: 5px; max-height: 400px; overflow-y: auto; }
        .log-entry { margin: 5px 0; padding: 5px; border-radius: 3px; font-family: monospace; font-size: 12px; }
        .service-status { display: inline-block; margin: 5px; padding: 5px 10px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>FanZone Service Validation Test Suite</h1>
    
    <div class="test-section">
        <h2>1. Service Validation Tests</h2>
        <button class="test-btn" onclick="testServiceValidation()">Test Service Validation</button>
        <button class="test-btn" onclick="testMethodValidation()">Test Method Validation</button>
        <button class="test-btn" onclick="testMultipleServices()">Test Multiple Services</button>
    </div>
    
    <div class="test-section">
        <h2>2. Fallback Wrapper Tests</h2>
        <button class="test-btn" onclick="testFallbackWrapper()">Test Fallback Wrapper</button>
        <button class="test-btn" onclick="testOfflineMode()">Test Offline Mode Services</button>
    </div>
    
    <div class="test-section">
        <h2>3. Service Health Checks</h2>
        <button class="test-btn" onclick="checkAllServices()">Check All Services Health</button>
        <button class="test-btn" onclick="testGracefulDegradation()">Test Graceful Degradation</button>
    </div>
    
    <div class="test-section">
        <h2>4. Controller Validation Tests</h2>
        <button class="test-btn" onclick="testControllerValidation()">Test Controller Service Validation</button>
        <button class="test-btn" onclick="testPurchaseWithValidation()">Test Purchase with Validation</button>
    </div>
    
    <div id="service-status"></div>
    
    <div id="logs">
        <h3>Test Logs:</h3>
    </div>
    
    <!-- Load all FanZone files -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="utils.js"></script>
    <script src="src/core/interfaces.js"></script>
    <script src="src/core/EventBus.js"></script>
    <script src="src/core/Logger.js"></script>
    <script src="src/core/ErrorHandler.js"></script>
    <script src="src/core/ServiceValidator.js"></script>
    <script src="src/core/DIContainer.js"></script>
    <script src="src/adapters/TelegramAdapter.js"></script>
    <script src="src/repositories/SupabaseRepository.js"></script>
    <script src="src/services/AuthService.js"></script>
    <script src="src/services/UserService.js"></script>
    <script src="src/services/GiftService.js"></script>
    <script src="src/controllers/GiftsController.js"></script>
    <script src="src/controllers/LeaderboardController.js"></script>
    <script src="src/controllers/ProfileController.js"></script>
    <script src="app.js"></script>
    
    <script>
        const logContainer = document.getElementById('logs');
        
        function addLog(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // Test Service Validation
        function testServiceValidation() {
            addLog('Testing service validation...', 'info');
            
            // Test valid service
            try {
                const logger = window.Logger;
                window.ServiceValidator.validateService(logger, 'Logger');
                addLog('✅ Logger validation passed', 'success');
            } catch (error) {
                addLog(`❌ Logger validation failed: ${error.message}`, 'error');
            }
            
            // Test null service
            try {
                window.ServiceValidator.validateService(null, 'NullService');
                addLog('❌ Null service validation should have failed', 'error');
            } catch (error) {
                addLog(`✅ Null service correctly rejected: ${error.message}`, 'success');
            }
            
            // Test uninitialized service
            try {
                const uninitService = { isInitialized: false };
                window.ServiceValidator.validateService(uninitService, 'UninitService');
                addLog('❌ Uninitialized service validation should have failed', 'error');
            } catch (error) {
                addLog(`✅ Uninitialized service correctly rejected: ${error.message}`, 'success');
            }
        }
        
        // Test Method Validation
        function testMethodValidation() {
            addLog('Testing method validation...', 'info');
            
            try {
                const logger = window.Logger;
                window.ServiceValidator.validateMethod(logger, 'info', 'Logger');
                addLog('✅ Logger.info method validation passed', 'success');
            } catch (error) {
                addLog(`❌ Logger.info validation failed: ${error.message}`, 'error');
            }
            
            try {
                const logger = window.Logger;
                window.ServiceValidator.validateMethod(logger, 'nonExistentMethod', 'Logger');
                addLog('❌ Non-existent method validation should have failed', 'error');
            } catch (error) {
                addLog(`✅ Non-existent method correctly rejected: ${error.message}`, 'success');
            }
        }
        
        // Test Multiple Services
        function testMultipleServices() {
            addLog('Testing multiple services validation...', 'info');
            
            const services = [
                { service: window.Logger, name: 'Logger' },
                { service: window.EventBus, name: 'EventBus' },
                { service: null, name: 'NullService' },
                { service: window.ErrorHandler, name: 'ErrorHandler' }
            ];
            
            const result = window.ServiceValidator.validateServices(services);
            
            addLog(`Validation result: ${result.valid ? 'VALID' : 'INVALID'}`, result.valid ? 'success' : 'error');
            
            if (result.errors.length > 0) {
                result.errors.forEach(err => {
                    addLog(`  - ${err.service}: ${err.error}`, 'warning');
                });
            }
        }
        
        // Test Fallback Wrapper
        function testFallbackWrapper() {
            addLog('Testing fallback wrapper...', 'info');
            
            // Create a fallback wrapper for a null service
            const fallbackService = window.ServiceValidator.createFallbackWrapper(
                null,
                'TestService',
                {
                    getData: async () => ({ test: 'fallback data' }),
                    process: () => 'fallback result'
                }
            );
            
            // Test fallback methods
            fallbackService.getData().then(data => {
                addLog(`✅ Fallback getData returned: ${JSON.stringify(data)}`, 'success');
            });
            
            const result = fallbackService.process();
            addLog(`✅ Fallback process returned: ${result}`, 'success');
            
            // Test missing method
            const missing = fallbackService.missingMethod();
            addLog(`Calling missing method returned: ${missing}`, 'warning');
        }
        
        // Test Offline Mode
        async function testOfflineMode() {
            addLog('Testing offline mode services...', 'info');
            
            // Enable offline mode
            localStorage.setItem('fanzone_offline_mode', 'true');
            
            try {
                // Initialize DIContainer
                await window.DIContainer.initializeApp();
                
                // Get services
                const authService = window.DIContainer.get('authService');
                const userService = window.DIContainer.get('userService');
                const giftService = window.DIContainer.get('giftService');
                
                // Test services in offline mode
                const user = authService.getCurrentUser();
                addLog(`AuthService (offline) user: ${user ? 'exists' : 'null'}`, user ? 'success' : 'warning');
                
                const gifts = await giftService.getAvailableGifts();
                addLog(`GiftService (offline) returned ${gifts.length} gifts`, gifts.length > 0 ? 'success' : 'warning');
                
                addLog('✅ Offline mode services working', 'success');
            } catch (error) {
                addLog(`❌ Offline mode test failed: ${error.message}`, 'error');
            }
            
            // Clear offline mode
            localStorage.removeItem('fanzone_offline_mode');
        }
        
        // Check All Services Health
        async function checkAllServices() {
            addLog('Checking all services health...', 'info');
            
            const statusDiv = document.getElementById('service-status');
            statusDiv.innerHTML = '<h3>Service Health Status:</h3>';
            
            try {
                // Initialize if needed
                if (!window.DIContainer.initialized) {
                    await window.DIContainer.initializeApp();
                }
                
                const services = [
                    'logger', 'eventBus', 'authService', 
                    'userService', 'giftService', 'platformAdapter'
                ];
                
                services.forEach(serviceName => {
                    try {
                        const service = window.DIContainer.get(serviceName);
                        const health = window.ServiceValidator.getServiceHealth(service, serviceName);
                        
                        const statusEl = document.createElement('div');
                        statusEl.className = `service-status ${health.healthy ? 'success' : 'warning'}`;
                        statusEl.innerHTML = `
                            <strong>${serviceName}:</strong> 
                            ${health.healthy ? '✅ Healthy' : '⚠️ Issues'}
                            ${health.issues.length > 0 ? `<br>Issues: ${health.issues.join(', ')}` : ''}
                        `;
                        statusDiv.appendChild(statusEl);
                        
                        addLog(`${serviceName}: ${health.healthy ? 'Healthy' : 'Has issues'}`, health.healthy ? 'success' : 'warning');
                    } catch (error) {
                        addLog(`${serviceName}: Failed to check - ${error.message}`, 'error');
                    }
                });
            } catch (error) {
                addLog(`❌ Health check failed: ${error.message}`, 'error');
            }
        }
        
        // Test Graceful Degradation
        async function testGracefulDegradation() {
            addLog('Testing graceful degradation...', 'info');
            
            try {
                // Simulate repository failure
                const mockRepo = null;
                
                // Create services with fallback
                const logger = window.Logger;
                const eventBus = window.EventBus;
                
                // Test auth service with no repository
                const authService = new window.AuthService(mockRepo, null, logger);
                const wrappedAuth = window.ServiceValidator.createFallbackWrapper(authService, 'AuthService', {
                    getCurrentUser: () => ({ id: 1, username: 'fallback_user' }),
                    isAuthenticated: () => true
                });
                
                const user = wrappedAuth.getCurrentUser();
                addLog(`Fallback auth returned user: ${user.username}`, 'success');
                
                const isAuth = wrappedAuth.isAuthenticated();
                addLog(`Fallback auth status: ${isAuth}`, 'success');
                
                addLog('✅ Graceful degradation working', 'success');
            } catch (error) {
                addLog(`❌ Graceful degradation failed: ${error.message}`, 'error');
            }
        }
        
        // Test Controller Validation
        async function testControllerValidation() {
            addLog('Testing controller service validation...', 'info');
            
            try {
                // Initialize services first
                if (!window.DIContainer.initialized) {
                    await window.DIContainer.initializeApp();
                }
                
                // Create controller with valid services
                const giftService = window.DIContainer.get('giftService');
                const userService = window.DIContainer.get('userService');
                const logger = window.DIContainer.get('logger');
                const eventBus = window.DIContainer.get('eventBus');
                
                const controller = new window.GiftsController(giftService, userService, logger, eventBus);
                addLog('✅ GiftsController created with validated services', 'success');
                
                // Try to create controller with null service
                try {
                    const badController = new window.GiftsController(null, userService, logger, eventBus);
                    addLog('❌ Controller should have rejected null service', 'error');
                } catch (error) {
                    addLog(`✅ Controller correctly rejected null service: ${error.message}`, 'success');
                }
                
            } catch (error) {
                addLog(`❌ Controller validation test failed: ${error.message}`, 'error');
            }
        }
        
        // Test Purchase with Validation
        async function testPurchaseWithValidation() {
            addLog('Testing purchase with service validation...', 'info');
            
            try {
                // Initialize app
                if (!window.FanZoneApp) {
                    await window.DIContainer.initializeApp();
                    window.FanZoneApp = new FanZoneApplication(window.DIContainer);
                    await window.FanZoneApp.initialize();
                }
                
                // Get controller
                const controller = window.FanZoneApp.giftsController;
                
                if (!controller) {
                    addLog('Creating new GiftsController...', 'info');
                    const giftService = window.DIContainer.get('giftService');
                    const userService = window.DIContainer.get('userService');
                    const logger = window.DIContainer.get('logger');
                    const eventBus = window.DIContainer.get('eventBus');
                    
                    const controller = new window.GiftsController(giftService, userService, logger, eventBus);
                    
                    // Test purchase validation (will fail without real gift)
                    try {
                        await controller.purchaseGift('test-gift-1');
                        addLog('Purchase attempt completed', 'info');
                    } catch (error) {
                        addLog(`Purchase validation caught error: ${error.message}`, 'warning');
                    }
                }
                
                addLog('✅ Purchase validation test completed', 'success');
                
            } catch (error) {
                addLog(`❌ Purchase validation test failed: ${error.message}`, 'error');
            }
        }
        
        // Initial log
        addLog('Service validation test suite loaded', 'success');
        addLog('ServiceValidator available: ' + (!!window.ServiceValidator), window.ServiceValidator ? 'success' : 'error');
    </script>
</body>
</html>